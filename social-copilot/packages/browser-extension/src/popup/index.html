<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Copilot</title>
    <link rel="stylesheet" href="popup.css">
  </head>
  <body>
    <div class="header">    <span>💬</span>
    <h1>Social Copilot</h1>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="settings">设置</button>
    <button class="tab" data-tab="contacts">联系人</button>
    <button class="tab" data-tab="about">关于</button>
  </div>

  <!-- 设置页 -->
  <div id="settings" class="tab-content active">
    <div id="status" class="status warning">正在检查状态...</div>

    <div class="fallback-card" style="margin-top: 12px;">
      <div class="form-group" style="margin-bottom: 10px;">
        <label style="font-weight: 600;">隐私告知（必选）</label>
        <small class="muted">生成建议时会将必要的对话上下文发送到你选择的第三方模型服务</small>
      </div>
      <div class="form-group inline" style="margin-bottom: 0;">
        <label for="privacyAcknowledged" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="privacyAcknowledged">
          我已理解并同意上述说明
        </label>
      </div>
    </div>

    <div class="form-group">
      <label for="provider">模型提供商</label>
      <select id="provider">
        <option value="deepseek">DeepSeek (推荐)</option>
        <option value="openai">OpenAI</option>
        <option value="claude">Claude</option>
      </select>
    </div>

    <div class="form-group">
      <label for="baseUrl">Base URL（可选）</label>
      <input type="text" id="baseUrl" placeholder="例如：https://api.deepseek.com" autocomplete="off">
      <small id="baseUrlHint" class="muted">留空则使用默认；仅支持官方域名；不要包含 <code>/v1</code></small>
    </div>

    <div class="form-group inline">
      <label for="allowInsecureHttp" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="allowInsecureHttp">
        允许 http Base URL
      </label>
      <small>仅用于本地代理或测试环境（可能降低安全性）</small>
    </div>

    <div class="form-group inline">
      <label for="allowPrivateHosts" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="allowPrivateHosts">
        允许本地/私有地址
      </label>
      <small>用于访问 localhost 或内网代理</small>
    </div>

    <div class="form-group">
      <label for="model">模型名称（可选）</label>
      <input type="text" id="model" placeholder="例如：deepseek-v3.2" list="modelSuggestions" autocomplete="off">
      <datalist id="modelSuggestions"></datalist>
      <small id="modelHint" class="muted">不填写则使用默认模型</small>
    </div>

    <div class="form-group">
      <label for="apiKey">API Key</label>
      <input type="password" id="apiKey" placeholder="sk-...">
      <small id="apiKeyHint">
        <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer">获取 DeepSeek API Key</a>
      </small>
    </div>

    <div class="form-group inline">
      <label for="persistApiKey" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="persistApiKey">
        记住 API Key
      </label>
      <small>不勾选则密钥仅本次浏览器会话有效（重启浏览器需重新输入）</small>
    </div>

    <div class="form-group inline">
      <label for="enableMemory" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="enableMemory">
        启用长期记忆
      </label>
      <small>后台会提炼并存储联系人摘要（默认关闭）</small>
    </div>

    <div class="form-group">
      <label for="language">回复语言</label>
      <select id="language">
        <option value="auto">自动（推荐）</option>
        <option value="zh">中文</option>
        <option value="en">English</option>
      </select>
      <small class="muted">选择 auto 时按当前对话自动决定中/英文输出</small>
    </div>

    <div class="form-group">
      <label for="temperature">温度（0-100）<span id="temperatureValue" class="muted" style="margin-left: 6px;">80</span></label>
      <input type="range" id="temperature" min="0" max="100" step="1" value="80">
      <small class="muted">越高越发散，越低越稳定</small>
    </div>

    <div class="form-group inline">
      <label for="autoInGroups" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="autoInGroups">
        群聊自动弹出
      </label>
      <small>默认关闭；群聊中仍可按 Alt+S 手动触发</small>
    </div>

    <div class="form-group inline">
      <label for="autoTrigger" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="autoTrigger" checked>
        收到消息自动生成建议
      </label>
      <small>关闭后仅可按 Alt+S 手动触发</small>
    </div>

    <div class="form-group inline">
      <label for="autoAgent" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="autoAgent">
        自动代理（收到消息自动发送）
      </label>
      <small class="muted">默认关闭；开启后会尝试自动填充并按 Enter 发送（不同平台可能无效或需手动确认）</small>
    </div>

    <div class="fallback-card" style="margin-top: 12px;">
      <div class="form-group" style="margin-bottom: 10px;">
        <label style="font-weight: 600;">提示词</label>
        <small class="muted">用于增强稳定性与个性化；会追加到默认提示词后（不影响对话内容脱敏）</small>
      </div>

      <div class="form-group">
        <label for="customSystemPrompt">自定义系统提示词（可选）</label>
        <textarea id="customSystemPrompt" rows="4" placeholder="例如：避免过度热情；尽量简短；不要使用表情符号。可用变量：{{contact_name}} {{app}} {{is_group}}"></textarea>
      </div>

      <div class="form-group" style="margin-bottom: 0;">
        <label for="customUserPrompt">自定义用户提示词（可选）</label>
        <textarea id="customUserPrompt" rows="4" placeholder="例如：如果对方提出问题，先确认需求再给建议。可用变量：{{contact_name}} {{styles}}"></textarea>
      </div>
    </div>

    <div class="fallback-card" style="margin-top: 12px;">
      <div class="form-group" style="margin-bottom: 10px;">
        <label style="font-weight: 600;">隐私与发送范围</label>
        <small class="muted">用于控制发送给模型的上下文大小与脱敏策略（不影响本地存储）</small>
      </div>

      <div class="form-group inline" style="margin-bottom: 10px;">
        <label for="redactPii" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="redactPii" checked>
          发送前脱敏（邮箱/手机号/链接）
        </label>
      </div>

      <div class="form-group inline" style="margin-bottom: 10px;">
        <label for="anonymizeSenders" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="anonymizeSenders" checked>
          不发送昵称（用「我/对方」替代）
        </label>
      </div>

      <div class="form-group">
        <label for="contextMessageLimit">发送最近消息条数</label>
        <input type="number" id="contextMessageLimit" min="1" max="50" placeholder="10">
        <small class="muted">仅影响发送给模型的上下文（当前消息始终包含）</small>
      </div>

      <div class="form-group">
        <label for="maxCharsPerMessage">单条消息最大字符数</label>
        <input type="number" id="maxCharsPerMessage" min="50" max="4000" placeholder="500">
      </div>

      <div class="form-group" style="margin-bottom: 0;">
        <label for="maxTotalChars">上下文总字符预算</label>
        <input type="number" id="maxTotalChars" min="200" max="20000" placeholder="4000">
      </div>
    </div>

    <div class="form-group inline">
      <label for="enableFallback" style="margin: 0; font-weight: 600;">
        <input type="checkbox" id="enableFallback">
        启用备用模型
      </label>
      <small>主模型异常时自动切换</small>
    </div>

    <div id="fallbackFields" class="fallback-card hidden">
      <div class="form-group">
        <label for="fallbackProvider">备用模型</label>
        <select id="fallbackProvider">
          <option value="deepseek">DeepSeek</option>
          <option value="openai">OpenAI</option>
          <option value="claude">Claude</option>
        </select>
      </div>

      <div class="form-group">
        <label for="fallbackBaseUrl">备用 Base URL（可选）</label>
        <input type="text" id="fallbackBaseUrl" placeholder="例如：https://api.deepseek.com" autocomplete="off">
        <small id="fallbackBaseUrlHint" class="muted">留空则使用默认；仅支持官方域名；不要包含 <code>/v1</code></small>
      </div>

      <div class="form-group inline">
        <label for="fallbackAllowInsecureHttp" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="fallbackAllowInsecureHttp">
          允许备用 http Base URL
        </label>
        <small>仅用于本地代理或测试环境</small>
      </div>

      <div class="form-group inline">
        <label for="fallbackAllowPrivateHosts" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="fallbackAllowPrivateHosts">
          允许备用本地/私有地址
        </label>
        <small>用于访问备用 localhost 或内网代理</small>
      </div>

      <div class="form-group">
        <label for="fallbackModel">备用模型名称（可选）</label>
        <input type="text" id="fallbackModel" placeholder="例如：deepseek-r1-0528" list="fallbackModelSuggestions" autocomplete="off">
        <datalist id="fallbackModelSuggestions"></datalist>
        <small id="fallbackModelHint" class="muted">不填写则使用该提供商默认模型</small>
      </div>

      <div class="form-group">
      <label for="fallbackApiKey">备用 API Key</label>
      <input type="password" id="fallbackApiKey" placeholder="sk-...">
      <small id="fallbackApiKeyHint">
          <a href="https://platform.deepseek.com/" target="_blank" rel="noopener noreferrer">获取 DeepSeek API Key</a>
        </small>
      </div>
    </div>

    <div class="form-group">
      <label>默认回复风格</label>
      <div class="style-options">
        <span class="style-option selected" data-style="caring" tabindex="0">💗 关心</span>
        <span class="style-option selected" data-style="humorous" tabindex="0">😄 幽默</span>
        <span class="style-option selected" data-style="casual" tabindex="0">😊 随意</span>
        <span class="style-option" data-style="rational" tabindex="0">🧠 理性</span>
        <span class="style-option" data-style="formal" tabindex="0">📝 正式</span>
      </div>
    </div>

    <div class="form-group">
      <label for="suggestionCount">每次显示的回复数量</label>
      <select id="suggestionCount">
        <option value="3">3 条（默认）</option>
        <option value="2">2 条</option>
      </select>
      <small class="muted">影响每次生成的回复建议条数</small>
    </div>

    <button id="testConnectionBtn" class="secondary">测试连接</button>
    <button id="saveBtn" class="primary">保存设置</button>

    <div class="shortcut-hint">
      💡 快捷键：按 <kbd>Alt</kbd> + <kbd>S</kbd> 手动触发建议
    </div>
  </div>

  <!-- 联系人页 -->
  <div id="contacts" class="tab-content">
    <div class="status info" style="margin-bottom: 10px;">
      <strong>支持平台</strong><br>
      Telegram Web、WhatsApp Web、Slack Web
    </div>
    <div class="muted" style="font-size: 12px; line-height: 1.4; margin: 0 0 12px;">
      联系人记录来自以上平台的对话（仅本地存储，不展示原文对话）。
    </div>
    <div id="contactList" class="contact-list">
      <div class="empty-state">暂无联系人记录</div>
    </div>
  </div>

  <!-- 关于页 -->
  <div id="about" class="tab-content">
    <div class="status info">
      <strong id="aboutVersion">Social Copilot</strong><br>
      AI 辅助社交伴侣
    </div>
    <p style="font-size: 13px; color: var(--muted); line-height: 1.6;">
      为聊天应用提供智能回复建议，支持 Telegram Web、WhatsApp Web、Slack Web。
    </p>
    <p style="font-size: 13px; color: var(--muted); line-height: 1.6; margin-top: 12px;">
      所有数据默认存储在本地，保护您的隐私。
    </p>
    <p style="font-size: 13px; color: var(--muted); line-height: 1.6; margin-top: 12px;">
      提示：生成回复时会将“必要的对话上下文”发送到你选择的第三方模型服务；可在设置页的「隐私与发送范围」中配置脱敏/匿名化与发送上限。
    </p>
    <p style="font-size: 12px; color: var(--muted-2); line-height: 1.6; margin-top: 8px;">
      <a href="https://github.com/your-org/social-copilot/blob/main/docs/PRIVACY.md" target="_blank" rel="noopener noreferrer">隐私政策</a>
    </p>

    <div class="fallback-card" style="margin-top: 12px;">
      <div class="form-group" style="margin-bottom: 12px;">
        <label style="font-weight: 600;">备份与恢复</label>
        <small class="muted">导出/导入联系人画像、风格偏好与长期记忆（不包含 API Key，也不包含原文对话消息）。</small>
      </div>
      <div class="button-stack">
        <button id="exportUserDataBtn" class="secondary">导出数据备份</button>
        <button id="importUserDataBtn" class="secondary">导入数据备份</button>
      </div>
      <input id="importUserDataFile" class="hidden" type="file" accept="application/json">
      <small class="muted" style="display: block; margin-top: 8px;">注意：备份文件包含本地画像/记忆等隐私信息，请妥善保管。</small>
    </div>

    <button id="clearDataBtn" class="secondary">清除所有数据</button>

    <div class="fallback-card" style="margin-top: 12px;">
      <div class="form-group inline" style="margin-bottom: 12px;">
        <label for="debugEnabled" style="margin: 0; font-weight: 600;">
          <input type="checkbox" id="debugEnabled">
          启用诊断日志
        </label>
        <small class="muted">记录最近请求，便于排查问题</small>
      </div>
      <div class="button-stack">
        <button id="copyDiagnosticsBtn" class="secondary">复制诊断信息</button>
        <button id="downloadDiagnosticsBtn" class="secondary">下载诊断 JSON</button>
        <button id="clearDiagnosticsBtn" class="secondary">清空诊断日志</button>
      </div>
    </div>
  </div>

  <script src="popup.js"></script>
</body>
</html>
