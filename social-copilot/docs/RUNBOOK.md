# Runbook（生产运行手册）

> 面向“已发布到 Chrome Web Store / 企业分发，并长期稳定运行”的排障与恢复流程。
>
> 原则：优先 **导出诊断** → **定位问题类别** → **最小化恢复动作**（不轻易清库），必要时再执行“清除数据”。

## 0. 先做：导出诊断（建议每次都带上）

1. 打开扩展设置页（点击扩展图标）
2. 打开「诊断与调试」
3. 点击「复制诊断」或「下载诊断 JSON」

诊断不会包含原文对话内容与 API Key（仅长度、枚举信息与错误栈），可安全用于提交 Issue/工单。

## 1. 常见故障与处理

### 1.1 “无法生成 / 请先设置 API Key”

可能原因：
- 未配置 API Key 或未启用备用模型
- 扩展未勾选“隐私告知确认”（首次使用必选）

处理步骤：
- 在设置页确认：已填写 API Key、已勾选隐私告知、提供商选择正确
- 如开启备用模型：确认备用 API Key 已填且提供商可用

### 1.2 频繁 429 / 5xx / 超时（模型服务不稳定）

现象：
- 提示里出现 “rate limit/429/timeout/5xx”
- 触发自动故障转移（fallback）

处理步骤：
- 确认主用与备用提供商都可用（至少准备 1 个备用）
- 降低请求压力：减少上下文消息条数、降低候选回复数量
- 若持续：建议切换到备用提供商，并在下一版发布前评估默认配置是否过于激进

### 1.3 提示“适配器异常 / 无法找到输入框”等（站点 DOM 变更）

现象：
- 面板提示适配器异常
- 自动弹出被禁用或无法注入

处理步骤：
- 确认站点是否为支持范围（Telegram/WhatsApp/Slack Web）以及是否处于正确的聊天视图
- 尝试刷新页面、重新打开聊天页面
- 导出诊断并提交 Issue：重点关注 `ADAPTER_HEALTH` 事件

### 1.4 设置页提示“本地数据库初始化失败”

含义：
- IndexedDB 初始化/迁移失败（可能由于浏览器异常退出、旧版本数据不一致、或删除被阻塞）

处理步骤（推荐顺序）：
1. 先导出诊断（包含 `storeError` / 迁移错误）
2. 关闭所有聊天站点标签页（Telegram/WhatsApp/Slack），避免 IndexedDB 删除被阻塞
3. 在扩展设置页点击「清除数据」进行恢复
4. 仍失败：重启浏览器后再试一次

说明：清除数据会删除本地的联系人画像/偏好/长期记忆与设置，请谨慎执行。

## 2. 回滚与紧急下线

### 2.1 回滚版本（推荐）

- 保留上一个稳定版本 zip（CI 产物或 GitHub Release）
- Chrome Web Store 选择回滚到上一版本（或企业分发重新推送旧版本）
- 发布后复查：三平台关键路径 + 设置页状态 + 诊断事件是否恢复正常

### 2.2 紧急下线（可选）

- 临时撤回/停止分发扩展版本
- 或通过发布一个“安全降级版本”（例如默认关闭自动触发）快速止血

