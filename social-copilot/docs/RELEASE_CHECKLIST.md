# Release Checklist（上线检查清单）

> 面向 Chrome Web Store（或企业内部分发）的发布检查清单。

## 0. 发布目标与范围

- 目标：内测 / 灰度 / 正式上架
- 覆盖平台：Telegram / WhatsApp / Slack（分别回归）
- 模型提供商：DeepSeek / OpenAI / Claude（至少主用 + 备用各回归 1 次）

## 1. 合规与用户告知（必做）

- 隐私政策 URL：准备并在商店后台填写（参考 `docs/PRIVACY.md`）
- 商店描述：明确“会将必要对话上下文发送到你选择的第三方模型服务”
- 扩展内告知：首次使用需在设置中确认隐私告知（否则不调用第三方模型）
- 数据控制：确认默认开启“脱敏 + 匿名化昵称”，并可在设置中关闭/调整
- 权限审计：
  - `storage` 是否为最小权限
  - `host_permissions` 仅包含必要域名与网站（不要写 `*://*/*`）
  - `optional_host_permissions` 为空（生产版本不启用可选站点权限）

## 2. 安全与密钥

- 默认不持久化 API Key；持久化为显式选择
- 禁止在日志/诊断中记录原文消息与密钥（仅长度/枚举信息）
- 诊断导出内容脱敏（不包含原文消息）
- 确认错误信息/栈中不会回显密钥（类似 `sk-...` / `sk-ant-...` 应被打码为 `***REDACTED***`）

## 3. 稳定性与兼容性

- 三个平台的关键路径回归：
  - 自动弹出/手动触发（Alt+S）
  - 候选回复填充输入框
  - 思路卡片点击后重新生成
  - 群聊策略（默认不自动弹出；可配置）
- 站点 DOM 变更兜底：
  - 适配器健康检查可报告并给出用户提示
  - 失败阈值后自动禁用自动弹出并尝试恢复

### 3.1 三平台手工回归步骤（建议每次发版都跑一遍）

前置：安装当前构建的扩展（`packages/browser-extension/dist`），并在设置页完成 API Key 配置。

**Telegram Web**

1. 打开 `https://web.telegram.org/` 并登录
2. 进入任意私聊：让对方发一条新消息，确认面板自动弹出并生成候选
3. 点击任一候选回复：确认文本填充到输入框
4. 点击思路卡片（共情/解决方案/幽默/中性）：确认重新生成，并且回复风格符合方向
5. 按 `Alt+S` 手动触发：确认可生成

**WhatsApp Web**

1. 打开 `https://web.whatsapp.com/` 并登录
2. 重复以上 2~5 步

**Slack Web**

1. 打开 `https://app.slack.com/` 并登录
2. 在任意频道或私聊重复以上 2~5 步

**群聊（所有平台可选）**

1. 默认：群聊不应自动弹出（设置页 `群聊自动弹出` 默认关闭）
2. 开启后：群聊收到新消息应自动弹出；关闭后恢复不自动弹出

### 3.2 可选：自动化 Smoke（需要本地已登录）

仓库已提供 Playwright smoke（会打开浏览器并检查适配器健康）：

```bash
cd social-copilot
pnpm e2e:smoke
```

## 4. 性能与成本

- 默认发送上下文大小：最近消息条数、单条/总字符预算合理
- 对 429/5xx/超时存在退避重试，但不应无限重试

## 5. 版本与变更记录

- `social-copilot/package.json` 的 `version` 已更新
- `social-copilot/CHANGELOG.md` 已补充（至少概述功能/修复/破坏性变更）
- 标签发布：`v<version>` 与 `package.json` 版本一致（workflow 会校验）

## 6. 构建与验证（必须全绿）

在 `social-copilot/` 下执行：

```bash
pnpm ci:local
```

并确认：

- `pnpm release:extension` 产物存在：`packages/browser-extension/release/social-copilot-<version>.zip`

## 7. 上架物料

- 图标、截图、描述、支持站点列表
- 变更说明（Release notes）
- 支持与反馈渠道（Issue / 邮箱 / 表单）

## 8. 发布后监控与回滚

- 预设“紧急下线/回滚版本”的流程
- 收集兼容性问题：优先关注站点选择器变更、输入框结构变化、登录态差异
- 恢复路径演练（建议发版前至少跑一次）：
  - 设置页可导出诊断 JSON
  - 设置页可导出/导入“数据备份”（画像/偏好/长期记忆），且不包含 API Key
  - 当本地数据库初始化失败时，能通过“清除数据”自助恢复（必要时先关闭聊天站点标签页避免删除被阻塞）
