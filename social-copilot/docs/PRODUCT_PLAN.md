# Social Copilot 产品方案（对话辅助与思路管理）

## 1. 目标
- 帮用户更好理解当前对话、降低“无从下手”的焦虑。
- 每次提供 2–3 条高质量回复建议，支持自动/手动触发。
- 通过“思路提示”帮助用户先选方向，再选回复，减少反复修改。
- 保持多平台（Telegram / WhatsApp / Slack）一致的体验与提示。

## 2. 关键能力与原则
- **建议数量**：默认 3 条（可配置 2–3），优先最近常用风格排序，允许手动刷新。
- **触发方式**：新消息自动弹出；快捷键 Alt+S 或 UI 按钮手动刷新。
- **思路提示**：在面板顶部展示 2–3 个“思路卡片”（例：关怀/共情、解决方案/建议、幽默化解），点击后刷新候选以匹配该思路。
- **风格偏好**：记录联系人历史选择，达到阈值自动设为默认；未命中时回退至全量风格的优先序。
- **稳定与安全**：LLM 统一使用 `profile_extraction` / `reply` 任务标识；提示要求 JSON 输出，建议加轻量 schema 校验与重试。

## 3. 交互与流程
1) **自动弹出**：收到新消息 → 拉取最近 10 条上下文 → 生成 3 条候选 → 面板显示，同时显示思路卡片。  
2) **手动刷新**：Alt+S 或刷新按钮 → 重新生成建议；若模型失败，展示错误并提供“重试”按钮。  
3) **选择与学习**：点击候选 → 自动填充输入框，记录该风格（用于偏好学习）；失败则复制到剪贴板并提示。  
4) **思路选择**：点击思路卡片 → 在输入中附加思路描述（如“保持关怀语气，安抚情绪”）→ 重新请求建议。  
5) **画像更新节流**：消息数每累计 N 条（默认 20）触发一次画像提取；无增量则跳过写入。

## 4. LLM 输入输出规范
- **任务类型**：`reply`（默认）/ `profile_extraction`。  
- **输入字段**：`context`（recentMessages + currentMessage）、`profile`、`memorySummary`、`styles`（优先序）、`language`、`maxLength`（可选）。  
- **提示要求**：  
  - 回复：输出 JSON 数组 `[{"style":"…","text":"…"}]`，风格在 `humorous/caring/rational/casual/formal` 集合；语言跟随用户选择。  
  - 画像：输出 JSON 对象，字段 `interests[]`、`communicationStyle{prefersShortMessages,usesEmoji,formalityLevel}`、`basicInfo{ageRange,occupation,location}`、`relationshipType`、`notes`；禁止多余文本。  
- **容错**：解析失败时降级为单条文本候选；建议添加 schema 校验与 1 次重试。

## 5. UI 设计要点
- **面板**：现有悬浮面板保留，增加“思路卡片”区域（最多 3 个小标签）；候选列表保持 3 条，支持滚动。  
- **状态提示**：加载中（转圈或文案）、错误（可重试按钮）、通知（fallback 切换）。  
- **快捷键**：Alt+S 触发/刷新，Esc 收起；保留按钮操作。  
- **位置记忆**：继续使用本地存储记录面板位置。

## 6. 数据与存储
- **消息与画像**：IndexedDB 按 contactKey 存储；消息去重（同 ID 覆盖）。  
- **风格偏好**：记录 count/lastUsed，阈值 ≥3 设为默认；按使用次数排序推荐。  
- **思路偏好（可选后续）**：记录用户点击的思路卡片，作为 Prompt 权重或排序依据。

## 7. 路线与任务拆分
短期（1 周内）：
- [x] 在 UI 增加思路卡片（前端刷新调用时附加思路描述）。  
- [ ] 配置建议条数开关（2/3）及默认风格选择入口保留。  
- [ ] 在 LLM 层增加 JSON schema 校验 + 简单重试。  
- [ ] 将画像更新写入逻辑加“无增量跳过”日志。

中期（2–3 周）：
- [ ] Vite Node API 迁移到 ESM，消除弃用警告。  
- [ ] 思路偏好持久化，并影响候选排序或提示词。  
- [ ] 新平台适配（Discord 等）前添加 DOM 选择器回退与监控日志。

## 8. 成功标准（验收）
- 新消息自动弹出，且 3 条候选在 1.5s 内返回（网络正常时）。  
- 手动刷新可用，失败时有清晰提示与重试按钮。  
- 思路卡片可选且生效（影响候选语气/内容），用户能感知差异。  
- 画像更新不频繁写入，无增量时不更新；风格偏好能自动设为默认。  
- 跨 Telegram / WhatsApp / Slack 的交互、提示一致。
